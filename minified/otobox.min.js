(function(n,l){"function"===typeof define&&define.amd?define([],l):n.otobox=l()})(this,function(){function n(a){return this._options.namingPrefix+a}function l(a){for(var b=0;b<this._activators.length;b++){var c=this._activators[b];if(c.name==a)return c}return null}function t(a){var b=null;if("string"==typeof a.key)try{b=RegExp(a.key)}catch(c){h.call(this,c.message)}else"object"==typeof a.key&&a.key instanceof RegExp?b=a.key:error.call(this,"Unable to match the entered character against activator key.");
return b}function u(){if(null!=this._currentActivator){var a=this._currentActivator,b=null;"string"==typeof a.sourceType?b=a.sourceType:"object"==typeof a.source?a.source instanceof Array&&(b="array"):"string"==typeof a.source&&(b="xhr");if(null!=b){if("function"==typeof p.prototype[b+"Source"])return p.prototype[b+"Source"];h.call(this,'No source with name "'+(b+"Source")+'" found.')}else h.call(this,"Activator's source is unknown.")}else h.call(this,"Current activator is empty.")}function C(){var a=
this._wrapper.querySelectorAll("ul."+(this._options.namingPrefix+"choices")+" > li");if(null!=a&&0<a.length)for(var b=0;b<a.length;b++)a[b].parentNode.removeChild(a[b])}function v(){var a=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")),b=a.querySelector("."+(this._options.namingPrefix+"hint"));null!=b&&b.parentNode.removeChild(b);r.call(this,a.textContent)}function s(a,b,c){a=q(c.templates.choice,{otobox_key:a,otobox_activator:c.name});a=q(a,b);b=document.createElement("div");
b.innerHTML=a;b=b.firstChild;b.setAttribute("data-choice",b.textContent);return b}function w(a){var b=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")),c=document.getSelection(),d=this._currentActivator;if(c.focusNode==b||3==c.focusNode.nodeType)d=s.call(this,this._stackActivator,a,d),a=document.createTextNode("\u00a0"),c.getRangeAt(0).insertNode(a),c.getRangeAt(0).insertNode(d),d=document.createRange(),d.setStart(a,1),d.collapse(!0),c.removeAllRanges(),c.addRange(d);g.call(this,
this._modes.normal);k.call(this,!1);r.call(this,b.textContent)}function x(a){var b=this;/loading/.test(this._wrapper.className)||(this._wrapper.className+=" "+(this._options.namingPrefix+"loading"));a.call(this,this._currentActivator,this._stack,this._options,function(a){var d=b._currentActivator;b._sourceResult=a;C.call(b);if("object"==typeof a&&a instanceof Array){var e=b._wrapper.querySelector("ul."+n.call(b,"choices"));if(0<a.length)for(var f=0;f<a.length;f++){var y=a[f],g=document.createElement("li"),
k=q(d.templates.suggestion,y),l=document.createElement("div");l.innerHTML=k;var m=l.firstChild;(function(a){m.onclick=function(){v.call(b);w.call(b,a)}})(y);g.appendChild(m);e.appendChild(g)}else g=document.createElement("li"),a=document.createElement("span"),a.className=n.call(b,"empty"),a.textContent="No result",g.appendChild(a),e.appendChild(g)}else h.call(b,"Source returned bad data type.");b._wrapper.className=b._wrapper.className.replace(RegExp(n.call(b,"loading")),"").trim()})}function k(a){a=
!!a;var b=this._wrapper;b.className=b.className.replace(/otobox-active/gi,"").trim();!0===a&&(b.className+=" otobox-active")}function g(a){if(a==this._modes.normal){this._stackActivator=this._stack="";this._currentMode=this._modes.normal;if(null!=this._currentActivator)if(this._currentActivator.customChoice){if(a=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")).querySelector("."+(this._options.namingPrefix+"hint")),null!=a){var b=m.call(this,a.textContent),b=s.call(this,
b.activatorKey,{otobox_value:b.hintText},b.activator);a.parentNode.insertBefore(b,a);a.parentNode.removeChild(a)}}else if(a=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")).querySelector("."+(this._options.namingPrefix+"hint")),null!=a){b=document.createTextNode(a.textContent);a.parentNode.insertBefore(b,a);a.parentNode.removeChild(a);var c=document.getSelection(),d=document.createRange();d.setStart(b,a.textContent.length);c.removeAllRanges();c.addRange(d)}this._currentActivator=
null}else a==this._modes.insert&&(this._stackActivator=this._stack="",this._currentMode=this._modes.insert)}function r(a){var b=this._targetObject;"undefined"!=typeof b.value?b.value=a:b.textContent=a}function m(a){if(0<this._activators.length){var b=a[0];a=a.substr(1,a.length-1);for(var c=0;c<this._activators.length;c++){var d=this._activators[c];if(d.key.test(b)&&d.allowedChars.test(a))return{activator:d,activatorKey:b,hintText:a}}}return null}function z(a,b){var c=document.createElement("span");
c.className=this._options.namingPrefix+"hint";c.setAttribute("data-activator",b.name);c.textContent=a;var d=document.getSelection();d.getRangeAt(0).insertNode(c);var e=document.createRange();e.setStart(c,1);d.removeAllRanges();d.addRange(e);return c}function D(a){if(this._currentMode==this._modes.normal){var b=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv"));a=document.getSelection().getRangeAt(0);if(a.startContainer.parentNode!=b)a=void 0;else{for(var b=3==a.startContainer.nodeType?
a.startContainer.textContent:b.textContent,c="",d=a.startOffset-1;0<=d;d--){var e=b[d];if(/\s/.test(e))break;c=e+c}for(var f="",d=a.startOffset;d<b.length;d++){e=b[d];if(/\s/.test(e))break;f+=e}a=m.call(this,c+f)}null!=a&&(g.call(this,this._modes.insert),this._currentActivator=a.activator,this._stackActivator=a.activatorKey,this._stack=a.hintText,a=z.call(this,this._stackActivator+this._stack,a.activator).previousSibling,3==a.nodeType&&(a.textContent=a.textContent.replace(this._stackActivator+this._stack,
"")))}}function E(a){var b;a:{b=String.fromCharCode(a.which);if(0<this._activators.length)for(var c=0;c<this._activators.length;c++){var d=this._activators[c];if(t.call(this,d).test(b)){b=d;break a}}b=null}c=document.getSelection().focusNode;this._currentMode==this._modes.normal&&null!=b&&/\s/.test(c.textContent[document.getSelection().focusOffset-1])?(g.call(this,this._modes.insert),this._currentActivator=b,this._stackActivator=String.fromCharCode(a.which),z.call(this,String.fromCharCode(a.which),
b),a.preventDefault()):this._currentMode==this._modes.insert&&/hint/.test(c.parentNode.className)&&(this._currentActivator.allowedChars.test(String.fromCharCode(a.which))?(this._stack+=String.fromCharCode(a.which),a=u.call(this),x.call(this,a),k.call(this,!0)):(g.call(this,this._modes.normal),k.call(this,!1)))}function F(a){var b=document.getSelection().focusNode,c=!1;if(this._currentMode==this._modes.normal&&null!=b&&b.parentNode.hasAttribute("data-choice")){b=b.parentNode;if(/\s/.test(String.fromCharCode(a.which))){a=
document.getSelection();var d=a.getRangeAt(0).startOffset,e="";b.textContent.length==d?e="\u00a0":(e=b.textContent.substr(0,d).trim(),d=b.textContent.substr(d,b.textContent.length),c=!0,b.textContent=e,e="\u00a0"+d);d=document.createTextNode(e);b.parentNode.insertBefore(d,b.nextSibling);e=document.createRange();e.setStart(d,1);e.collapse(!0);a.removeAllRanges();a.addRange(e);b.textContent=b.textContent.trim()}if(l.call(this,b.getAttribute("data-activator")).customChoice)c=m.call(this,b.textContent),
null!=c&&b.setAttribute("data-value",c.hintText);else if(b.getAttribute("data-choice")!=b.textContent){var f=document.getSelection(),d=f.getRangeAt(0).startOffset,e=document.createRange();a=document.createTextNode(b.textContent);b.parentNode.insertBefore(a,b);b.parentNode.removeChild(b);c||(e.setStart(a,d),e.collapse(!0),f.removeAllRanges(),f.addRange(e))}}c=this._wrapper.querySelectorAll("*[data-choice]");for(b=0;b<c.length;b++)d=c[b],m.call(this,d.textContent)||(a=document.createTextNode(d.textContent),
d.parentNode.insertBefore(a,d),d.parentNode.removeChild(d))}function G(){if(this._currentMode==this._modes.insert){var a=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")+" ."+(this._options.namingPrefix+"hint"));if(null==a||""==a.textContent||a.textContent==this._stackActivator)g.call(this,this._modes.normal),k.call(this,!1)}}function H(){if(this._currentMode==this._modes.insert){var a=u.call(this);x.call(this,a);k.call(this,!0)}}function I(){if(this._currentMode==this._modes.insert){var a=
this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")+" ."+(this._options.namingPrefix+"hint"));if(null!=a){var b=a.getAttribute("data-activator");l.call(this,b);a=m.call(this,a.textContent);null!=a&&(this._stack=a.hintText)}}}function A(a,b){if(this._currentMode==this._modes.insert){var c=this._wrapper.querySelector("."+(this._options.namingPrefix+"active"));null!=c?(c.className="",c=b?c.previousSibling:c.nextSibling):c=b?this._wrapper.querySelector("ul."+(this._options.namingPrefix+
"choices")+" > li:last-child"):this._wrapper.querySelector("ul."+(this._options.namingPrefix+"choices")+" > li:first-child");null!=c&&(c.className=this._options.namingPrefix+"active");a.preventDefault()}}function J(a,b){for(var c=this._sourceResult,d=0;d<c.length;d++){var e=c[d];if(e[b.valueKey]==a)return e}}function K(a){var b=this,c=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv"));c.onkeypress=function(a){D.call(b,a);E.call(b,a)};c.onkeydown=function(a){38==a.keyCode&&
A.call(b,a,!0);40==a.keyCode&&A.call(b,a,!1);if(13==a.keyCode){if(b._currentMode==b._modes.insert){var c=b._wrapper.querySelector("li."+n.call(b,"active")+" a"),c=J.call(b,c.getAttribute("data-value"),b._currentActivator);v.call(b);w.call(b,c);a.preventDefault()}"input"==b._targetObject.nodeName.toLowerCase()&&a.preventDefault()}};c.onkeyup=function(a){F.call(b,a);r.call(b,c.textContent);if(46==a.keyCode||8==a.keyCode)I.call(b),H.call(b),G.call(b);if(37==a.keyCode||39==a.keyCode)g.call(b,b._modes.normal),
k.call(b,!1);32==a.keyCode&&(g.call(b,b._modes.normal),k.call(b,!1));27==a.keyCode&&(g.call(b,b._modes.normal),k.call(b,!1),a.stopPropagation(),a.preventDefault())}}function h(a){throw Error("otobox - "+a);}function q(a,b){return a.replace(/{{(\w+)}}/g,function(a,d){return"undefined"!=typeof b[d]?b[d]:a})}function B(a,b){for(var c=0;c<a.length;c++){var d=a[c];d.otobox_value=d[b.valueKey]}return a}var p=function(a){this._options={valueKey:"value",namingPrefix:"otobox-",templates:{suggestion:'<a href="javascript:void(0);" data-value="{{otobox_value}}">{{display}}</a>',
choice:'<a data-value="{{otobox_value}}" data-key="{{otobox_key}}" data-activator="{{otobox_activator}}" data-choice="" class="otobox-choiceItem">{{otobox_key}}{{display}}</a>'}};this._activators=[];this._stackActivator=this._stack="";this._modes={normal:0,insert:1};this._currentMode=this._modes.normal;var b=this._sourceResult=this._wrapper=this._currentActivator=null;"object"==typeof a?b=a:"string"==typeof a?(a=document.querySelector(a),null!=a?b=a:h.call(this,"Unable to find the target object with the given CSS selector.")):
h.call(this,"Unable to initiate with the given parameter for init.");if(null!=b){this._targetObject=b;var c=b.getBoundingClientRect();a=this._wrapper=document.createElement("div");a.className=this._options.namingPrefix+"wrapper";""!=b.className&&(a.className+=" "+b.className);b.parentNode.insertBefore(a,b);b.className+=" "+(this._options.namingPrefix+"input");a.appendChild(b);var d=document.createElement("div");d.setAttribute("contenteditable",!0);d.setAttribute("data-placeholder",b.placeholder);
d.className=this._options.namingPrefix+"editableDiv";a.style.width=c.width+"px";"textarea"==b.nodeName.toLowerCase()?(d.className+=" "+(this._options.namingPrefix+"textarea-target"),a.style.height=c.height+"px"):d.className+=" "+(this._options.namingPrefix+"input-target");a.appendChild(d);c=document.createElement("ul");c.className=this._options.namingPrefix+"choices";a.appendChild(c);c=document.createElement("div");c.className=this._options.namingPrefix+"loadingElement";a.appendChild(c);K.call(this,
b)}else h.call(this,"targetObject is empty.")};p.prototype={setOption:function(a,b){this._options[a]=b;return this},setOptions:function(a){var b=this._options,c={},d;for(d in b)c[d]=b[d];for(d in a)c[d]=a[d];this._options=c;return this},addActivator:function(a){null!=a?"undefined"!=typeof a.key&&"undefined"!=typeof a.source&&"undefined"!=typeof a.name?(a.allowedChars=a.allowedChars||/.+/,a.tempKey=a.key,a.key=t.call(this,a),a.customChoice=!!a.customChoice,a.valueKey=a.valueKey||this._options.valueKey,
"object"!=typeof a.templates&&(a.templates=this._options.templates),this._activators.push(a)):h.call(this,"Name, key and source fields are mandatory for activator object."):h.call(this,"Activator object is empty.");return this},addChoice:function(a,b){var c=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")),d=l.call(this,a),d=s.call(this,d.tempKey,b,d);c.appendChild(d);return this},getChoices:function(){for(var a={},b=this._wrapper.querySelectorAll("."+(this._options.namingPrefix+
"editableDiv")+" *[data-choice]"),c=0;c<b.length;c++){var d=b[c],e=d.getAttribute("data-activator");"undefined"==typeof a[e]&&(a[e]=[]);a[e].push(d.getAttribute("data-value"))}return a},arraySource:function(a,b,c,d){c=[];for(var e=0;e<a.source.length;e++){var f=a.source[e];if(RegExp(b,"gi").test(f)){var g={};g.value=f;g.display=f;c.push(g)}}d.call(this,B.call(this,c,a))},xhrSource:function(a,b,c,d){var e=this,f=new XMLHttpRequest;f.open("GET",q(a.source,{keyword:b}),!0);f.onreadystatechange=function(){if(4==
f.readyState&&200==f.status){var b=JSON.parse(f.responseText);"function"==typeof a.postFetch&&(b=a.postFetch.call(e,b));d.call(e,B.call(e,b,a))}};f.send()}};return p});
