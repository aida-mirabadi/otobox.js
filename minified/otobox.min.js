(function(p,n){"function"===typeof define&&define.amd?define([],n):p.otobox=n()})(this,function(){function p(a){return this._options.namingPrefix+a}function n(a){var b=null;if("string"==typeof a.key)try{b=RegExp(a.key)}catch(c){h.call(this,c.message)}else"object"==typeof a.key&&a.key instanceof RegExp?b=a.key:error.call(this,"Unable to match the entered character against activator key.");return b}function s(){if(null!=this._currentActivator){var a=this._currentActivator,b=null;"string"==typeof a.sourceType?
b=a.sourceType:"object"==typeof a.source?a.source instanceof Array&&(b="array"):"string"==typeof a.source&&(b="xhr");if(null!=b){if("function"==typeof q.prototype[b+"Source"])return q.prototype[b+"Source"];h.call(this,'No source with name "'+(b+"Source")+'" found.')}else h.call(this,"Activator's source is unknown.")}else h.call(this,"Current activator is empty.")}function A(){var a=this._wrapper.querySelectorAll("ul."+(this._options.namingPrefix+"choices")+" > li");if(null!=a&&0<a.length)for(var b=
0;b<a.length;b++)a[b].parentNode.removeChild(a[b])}function t(){var a=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")),b=a.querySelector("."+(this._options.namingPrefix+"hint"));null!=b&&b.parentNode.removeChild(b);r.call(this,a.textContent)}function u(a,b,c,d,e){a.textContent=(e.includeKey?b:"")+d;a.setAttribute("data-value",c);a.setAttribute("data-display",d);a.setAttribute("data-key",b);a.setAttribute("data-activator",e.name)}function v(a){var b=this._wrapper.querySelector("."+
(this._options.namingPrefix+"editableDiv")),c=document.getSelection(),d=this._currentActivator;if(c.focusNode==b||3==c.focusNode.nodeType){var e=this._stackActivator,f=a[d.valueKey],g=a[d.displayKey];a=document.createElement("a");a.className=this._options.namingPrefix+"choiceItem";u.call(this,a,e,f,g,d);d=document.createTextNode("\u00a0");c.getRangeAt(0).insertNode(d);c.getRangeAt(0).insertNode(a);e=document.createRange();e.setStart(d,1);e.collapse(!0);c.removeAllRanges();c.addRange(e)}l.call(this,
this._modes.normal);m.call(this,!1);r.call(this,b.textContent)}function w(a){var b=this;A.call(this);a.call(this,this._currentActivator,this._stack,this._options,function(a){if("object"==typeof a&&a instanceof Array){var d=b._wrapper.querySelector("ul."+p.call(b,"choices"));if(0<a.length)for(var e=0;e<a.length;e++){var f=a[e],g=document.createElement("li"),k=document.createElement("a");k.href="javascript:void(0);";k.setAttribute("data-value",f[b._currentActivator.valueKey]);k.setAttribute("data-display",
f[b._currentActivator.displayKey]);k.textContent=f[b._options.displayKey];(function(a){k.onclick=function(){t.call(b);v.call(b,a)}})(f);g.appendChild(k);d.appendChild(g)}else g=document.createElement("li"),a=document.createElement("span"),a.textContent="No result",g.appendChild(a),d.appendChild(g)}else h.call(b,"Source returned bad data type.")})}function m(a){a=!!a;var b=this._wrapper;b.className=b.className.replace(/otobox-active/gi,"").trim();!0===a&&(b.className+=" otobox-active")}function l(a){if(a==
this._modes.normal){if(this._stackActivator=this._stack="",this._currentMode=this._modes.normal,a=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")).querySelector("."+(this._options.namingPrefix+"hint")),null!=a){var b=document.createTextNode(a.textContent);a.parentNode.insertBefore(b,a);a.parentNode.removeChild(a);var c=document.getSelection(),d=document.createRange();d.setStart(b,a.textContent.length);c.removeAllRanges();c.addRange(d)}}else a==this._modes.insert&&(this._stackActivator=
this._stack="",this._currentMode=this._modes.insert)}function r(a){var b=this._targetObject;"undefined"!=typeof b.value?b.value=a:b.textContent=a}function x(a){if(0<this._activators.length){for(var b=a[0],c=a.substr(1,a.length-1),d=0;d<this._activators.length;d++){var e=this._activators[d];if(e.key.test(b)&&e.allowedChars.test(c))return{activator:e,activatorKey:b,hintText:c}}for(d=0;d<this._activators.length;d++)if(e=this._activators[d],!e.includeKey&&e.allowedChars.test(a))return{activator:e,activatorKey:b,
hintText:c}}return null}function y(a,b){var c=document.createElement("span");c.className=this._options.namingPrefix+"hint";c.setAttribute("data-activator",b.name);c.textContent=a;var d=document.getSelection();d.getRangeAt(0).insertNode(c);var e=document.createRange();e.setStart(c,1);d.removeAllRanges();d.addRange(e);return c}function B(a){if(this._currentMode==this._modes.normal){var b=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv"));a=document.getSelection().getRangeAt(0);
if(a.startContainer.parentNode!=b)a=void 0;else{for(var b=3==a.startContainer.nodeType?a.startContainer.textContent:b.textContent,c="",d=a.startOffset-1;0<=d;d--){var e=b[d];if(/\s/.test(e))break;c=e+c}for(var f="",d=a.startOffset;d<b.length;d++){e=b[d];if(/\s/.test(e))break;f+=e}a=x.call(this,c+f)}null!=a&&(l.call(this,this._modes.insert),this._currentActivator=a.activator,this._stackActivator=a.activatorKey,this._stack=a.hintText,a=y.call(this,this._stackActivator+this._stack,a.activator).previousSibling,
3==a.nodeType&&(a.textContent=""))}}function C(a){var b;a:{b=String.fromCharCode(a.which);if(0<this._activators.length)for(var c=0;c<this._activators.length;c++){var d=this._activators[c];if(n.call(this,d).test(b)){b=d;break a}}b=null}c=document.getSelection().focusNode;this._currentMode==this._modes.normal&&null!=b?(l.call(this,this._modes.insert),this._currentActivator=b,this._stackActivator=String.fromCharCode(a.which),y.call(this,String.fromCharCode(a.which),b),a.preventDefault()):this._currentMode==
this._modes.insert&&/hint/.test(c.parentNode.className)&&(this._currentActivator.allowedChars.test(String.fromCharCode(a.which))?(this._stack+=String.fromCharCode(a.which),a=s.call(this),w.call(this,a),m.call(this,!0)):(l.call(this,this._modes.normal),m.call(this,!1)))}function D(a){var b=document.getSelection().focusNode,c=this._currentActivator,d=!1;if(this._currentMode==this._modes.normal&&/choiceItem/.test(b.parentNode.className)){b=b.parentNode;if(/\s/.test(String.fromCharCode(a.which))){a=document.getSelection();
var e=a.getRangeAt(0).startOffset,f="";b.textContent.length==e?f="\u00a0":(f=b.textContent.substr(0,e).trim(),e=b.textContent.substr(e,b.textContent.length),d=!0,b.textContent=f,f="\u00a0"+e);e=document.createTextNode(f);b.parentNode.insertBefore(e,b.nextSibling);f=document.createRange();f.setStart(e,1);f.collapse(!0);a.removeAllRanges();a.addRange(f);b.textContent=b.textContent.trim()}c.customChoice?(d=x.call(this,b.textContent),null!=d?u.call(this,b,d.activatorKey,d.hintText,d.hintText,d.activator):
(c=document.createTextNode(b.textContent),b.parentNode.insertBefore(c,b),b.parentNode.removeChild(b))):(a=document.getSelection(),e=a.getRangeAt(0).startOffset,f=document.createRange(),c=document.createTextNode(b.textContent),b.parentNode.insertBefore(c,b),b.parentNode.removeChild(b),d||(f.setStart(c,e),f.collapse(!0),a.removeAllRanges(),a.addRange(f)))}}function E(){if(this._currentMode==this._modes.insert){var a=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")+" ."+(this._options.namingPrefix+
"hint"));if(null==a||""==a.textContent||a.textContent==this._stackActivator)l.call(this,this._modes.normal),m.call(this,!1)}}function F(){if(this._currentMode==this._modes.insert){var a=s.call(this);w.call(this,a);m.call(this,!0)}}function G(){if(this._currentMode==this._modes.insert){var a=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")+" ."+(this._options.namingPrefix+"hint")),b=a.getAttribute("data-activator");a:{for(var c=0;c<this._activators.length;c++){var d=this._activators[c];
if(d.name==b){b=d;break a}}b=null}this._stack=b.includeKey?a.textContent.substr(1,a.textContent.length):a.textContent}}function z(a,b){if(this._currentMode==this._modes.insert){var c=this._wrapper.querySelector("."+(this._options.namingPrefix+"active"));null!=c?(c.className="",c=b?c.previousSibling:c.nextSibling):c=b?this._wrapper.querySelector("ul."+(this._options.namingPrefix+"choices")+" > li:last-child"):this._wrapper.querySelector("ul."+(this._options.namingPrefix+"choices")+" > li:first-child");
null!=c&&(c.className=this._options.namingPrefix+"active");a.preventDefault()}}function H(a){var b=this,c=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv"));c.onkeypress=function(a){B.call(b,a);C.call(b,a)};c.onkeydown=function(a){38==a.keyCode&&z.call(b,a,!0);40==a.keyCode&&z.call(b,a,!1);if(13==a.keyCode){if(b._currentMode==b._modes.insert){var c=b._wrapper.querySelector("li."+p.call(b,"active")+" a"),f={};f[b._currentActivator.displayKey]=c.getAttribute("data-display");
f[b._currentActivator.valueKey]=c.getAttribute("data-value");t.call(b);v.call(b,f)}a.preventDefault()}};c.onkeyup=function(a){D.call(b,a);r.call(b,c.textContent);if(46==a.keyCode||8==a.keyCode)G.call(b),F.call(b),E.call(b);if(37==a.keyCode||39==a.keyCode)l.call(b,b._modes.normal),m.call(b,!1);32==a.keyCode&&(l.call(b,b._modes.normal),m.call(b,!1));27==a.keyCode&&(l.call(b,b._modes.normal),m.call(b,!1))}}function h(a){throw Error("otobox - "+a);}var q=function(a){this._options={displayKey:"name",valueKey:"value",
namingPrefix:"otobox-"};this._activators=[];this._stackActivator=this._stack="";this._modes={normal:0,insert:1};this._currentMode=this._modes.normal;var b=this._wrapper=this._currentActivator=null;"object"==typeof a?b=a:"string"==typeof a?(a=document.querySelector(a),null!=a?b=a:h.call(this,"Unable to find the target object with the given CSS selector.")):h.call(this,"Unable to initiate with the given parameter for init.");if(null!=b){this._targetObject=b;var c=b.getBoundingClientRect();a=this._wrapper=
document.createElement("div");a.className=this._options.namingPrefix+"wrapper";""!=b.className&&(a.className=" "+b.className);b.parentNode.insertBefore(a,b);b.className+=" "+(this._options.namingPrefix+"input");a.appendChild(b);var d=document.createElement("div");d.setAttribute("contenteditable",!0);d.setAttribute("data-placeholder",b.placeholder);d.className=this._options.namingPrefix+"editableDiv";a.style.width=c.width+"px";"textarea"==b.nodeName.toLowerCase()?(d.className+=" "+(this._options.namingPrefix+
"textarea-target"),a.style.height=c.height+"px"):d.className+=" "+(this._options.namingPrefix+"input-target");a.appendChild(d);c=document.createElement("ul");c.className=this._options.namingPrefix+"choices";a.appendChild(c);H.call(this,b)}else h.call(this,"targetObject is empty.")};q.prototype={addActivator:function(a){null!=a?"undefined"!=typeof a.key&&"undefined"!=typeof a.source&&"undefined"!=typeof a.name?(a.allowedChars=a.allowedChars||/.+/,a.key=n.call(this,a),a.customChoice=!!a.customChoice,
a.displayKey=a.displayKey||this._options.displayKey,a.valueKey=a.valueKey||this._options.valueKey,a.includeKey="undefined"!=typeof a.includeKey?!!a.includeKey:!0,this._activators.push(a)):h.call(this,"Name, key and source fields are mandatory for activator object."):h.call(this,"Activator object is empty.");return this},arraySource:function(a,b,c,d){for(var e=[],f=0;f<a.source.length;f++){var g=a.source[f];if(RegExp(b,"gi").test(g)){var k={};k[c.displayKey]=g;k[c.valueKey]=g;e.push(k)}}d.call(this,
e)},xhrSource:function(a,b,c,d){var e=[],f={},g=new XMLHttpRequest;g.open("POST",a.source,!0);g.onreadystatechange=function(){if(4==g.readyState&&200==g.status){for(var a=JSON.parse(g.responseText),b=0;b<a.length;b++)f[c.displayKey]=a[b].displayName,f[c.displayKey]=a[b].username,e.push(f),f={};d.call(this,e)}};g.send("name="+b)}};return q});
