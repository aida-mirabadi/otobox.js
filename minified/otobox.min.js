(function(q,m){"function"===typeof define&&define.amd?define([],m):q.otobox=m()})(this,function(){function q(a){return this._options.namingPrefix+a}function m(a){var b=null;if("string"==typeof a.key)try{b=RegExp(a.key)}catch(d){h.call(this,d.message)}else"object"==typeof a.key&&a.key instanceof RegExp?b=a.key:error.call(this,"Unable to match the entered character against activator key.");return b}function r(){if(null!=this._currentActivator){var a=this._currentActivator,b=null;"string"==typeof a.sourceType?
b=a.sourceType:"object"==typeof a.source?a.source instanceof Array&&(b="array"):"string"==typeof a.source&&(b="xhr");if(null!=b){if("function"==typeof p.prototype[b+"Source"])return p.prototype[b+"Source"];h.call(this,'No source with name "'+(b+"Source")+'" found.')}else h.call(this,"Activator's source is unknown.")}else h.call(this,"Current activator is empty.")}function y(){var a=this._wrapper.querySelectorAll("ul."+(this._options.namingPrefix+"choices")+" > li");if(null!=a&&0<a.length)for(var b=
0;b<a.length;b++)a[b].parentNode.removeChild(a[b])}function z(){var a=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")),b=a.querySelector("."+(this._options.namingPrefix+"hint"));null!=b&&b.parentNode.removeChild(b);s.call(this,a.innerText)}function t(a,b,d,c,e){a.innerText=(e.includeKey?b:"")+c;a.setAttribute("data-value",d);a.setAttribute("data-display",c);a.setAttribute("data-key",b);a.setAttribute("data-activator",e.name)}function A(a){var b=this._wrapper.querySelector("."+
(this._options.namingPrefix+"editableDiv")),d=document.getSelection(),c=this._currentActivator;if(d.focusNode==b||3==d.focusNode.nodeType){var b=this._stackActivator,e=a[c.valueKey],f=a[c.displayKey];a=document.createElement("a");a.className=this._options.namingPrefix+"choiceItem";t.call(this,a,b,e,f,c);c=document.createTextNode("\u00a0");d.getRangeAt(0).insertNode(c);d.getRangeAt(0).insertNode(a);b=document.createRange();b.setStart(c,1);b.collapse(!0);d.removeAllRanges();d.addRange(b)}k.call(this,
this._modes.normal);l.call(this,!1)}function u(a){var b=this;y.call(this);a.call(this,this._currentActivator,this._stack,this._options,function(a){if("object"==typeof a&&a instanceof Array){var c=b._wrapper.querySelector("ul."+q.call(b,"choices"));if(0<a.length)for(var e=0;e<a.length;e++){var f=a[e],g=document.createElement("li"),n=document.createElement("a");n.href="javascript:void(0);";n.setAttribute("data-value",f[b._options.valueKey]);n.innerText=f[b._options.displayKey];(function(a){n.onclick=
function(){z.call(b);A.call(b,a)}})(f);g.appendChild(n);c.appendChild(g)}else g=document.createElement("li"),g.innerHTML="No result",c.appendChild(g)}else h.call(b,"Source returned bad data type.")})}function l(a){a=!!a;var b=this._wrapper;b.className=b.className.replace(/otobox-active/gi,"").trim();!0===a&&(b.className+=" otobox-active")}function k(a){if(a==this._modes.normal){if(this._stackActivator=this._stack="",this._currentMode=this._modes.normal,a=this._wrapper.querySelector("."+(this._options.namingPrefix+
"editableDiv")).querySelector("."+(this._options.namingPrefix+"hint")),null!=a){var b=document.createTextNode(a.innerText);a.parentNode.insertBefore(b,a);a.parentNode.removeChild(a);var d=document.getSelection(),c=document.createRange();c.setStart(b,a.innerText.length);d.removeAllRanges();d.addRange(c)}}else a==this._modes.insert&&(this._stackActivator=this._stack="",this._currentMode=this._modes.insert)}function s(a){var b=this._targetObject;"undefined"!=typeof b.value?b.value=a:b.innerText=a}function v(a){if(0<
this._activators.length){for(var b=a[0],d=a.substr(1,a.length-1),c=0;c<this._activators.length;c++){var e=this._activators[c];if(e.key.test(b)&&e.allowedChars.test(d))return{activator:e,activatorKey:b,hintText:d}}for(c=0;c<this._activators.length;c++)if(e=this._activators[c],!e.includeKey&&e.allowedChars.test(a))return{activator:e,activatorKey:b,hintText:d}}return null}function w(a,b){var d=document.createElement("span");d.className=this._options.namingPrefix+"hint";d.setAttribute("data-activator",
b.name);d.innerText=a;var c=document.getSelection();c.getRangeAt(0).insertNode(d);var e=document.createRange();e.setStart(d,1);c.removeAllRanges();c.addRange(e);return d}function B(a){if(this._currentMode==this._modes.normal){var b=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv"));a=document.getSelection().getRangeAt(0);if(a.startContainer.parentNode!=b)a=void 0;else{for(var b=3==a.startContainer.nodeType?a.startContainer.textContent:b.innerText,d="",c=a.startOffset-1;0<=
c;c--){var e=b[c];if(/\s/.test(e))break;d=e+d}for(var f="",c=a.startOffset;c<b.length;c++){e=b[c];if(/\s/.test(e))break;f+=e}a=v.call(this,d+f)}null!=a&&(k.call(this,this._modes.insert),this._currentActivator=a.activator,this._stackActivator=a.activatorKey,this._stack=a.hintText,a=w.call(this,this._stackActivator+this._stack,a.activator).previousSibling,3==a.nodeType&&(a.textContent=""))}}function C(a){var b;a:{b=String.fromCharCode(a.which);if(0<this._activators.length)for(var d=0;d<this._activators.length;d++){var c=
this._activators[d];if(m.call(this,c).test(b)){b=c;break a}}b=null}d=document.getSelection().focusNode;this._currentMode==this._modes.normal&&null!=b?(k.call(this,this._modes.insert),this._currentActivator=b,this._stackActivator=String.fromCharCode(a.which),w.call(this,String.fromCharCode(a.which),b),a.preventDefault()):this._currentMode==this._modes.insert&&/hint/.test(d.parentNode.className)&&(this._currentActivator.allowedChars.test(String.fromCharCode(a.which))?(this._stack+=String.fromCharCode(a.which),
a=r.call(this),u.call(this,a),l.call(this,!0)):(k.call(this,this._modes.normal),l.call(this,!1)))}function x(a){var b=document.getSelection().focusNode,d=this._currentActivator,c=!1;if(this._currentMode==this._modes.normal&&/choiceItem/.test(b.parentNode.className)){b=b.parentNode;if(/\s/.test(String.fromCharCode(a.which))){var e=document.getSelection(),f=e.getRangeAt(0).startOffset,g="";b.innerText.length==f?g="\u00a0":(g=b.innerText.substr(0,f),f=b.innerText.substr(f,b.innerText.length),c=!0,b.innerText=
g,g="\u00a0"+f);f=document.createTextNode(g);b.parentNode.insertBefore(f,b.nextSibling);g=document.createRange();g.setStart(f,1);g.collapse(!0);e.removeAllRanges();e.addRange(g);a.preventDefault()}d.customChoice?(c=v.call(this,b.innerText),t.call(this,b,c.activatorKey,c.hintText,c.hintText,c.activator)):(a=document.getSelection(),f=a.getRangeAt(0).startOffset,g=document.createRange(),d=document.createTextNode(b.innerText),b.parentNode.insertBefore(d,b),b.parentNode.removeChild(b),c||(g.setStart(d,
f),g.collapse(!0),a.removeAllRanges(),a.addRange(g)))}}function D(){if(this._currentMode==this._modes.insert){var a=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")+" ."+(this._options.namingPrefix+"hint"));if(null==a||""==a.innerText||a.innerText==this._stackActivator)k.call(this,this._modes.normal),l.call(this,!1)}}function E(){if(this._currentMode==this._modes.insert){var a=r.call(this);u.call(this,a);l.call(this,!0)}}function F(){if(this._currentMode==this._modes.insert){var a=
this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")+" ."+(this._options.namingPrefix+"hint")),b=a.getAttribute("data-activator");a:{for(var d=0;d<this._activators.length;d++){var c=this._activators[d];if(c.name==b){b=c;break a}}b=null}b.includeKey?(console.log(a.innerText),this._stack=a.innerText.substr(1,a.innerText.length)):this._stack=a.innerText}}function G(a){var b=this,d=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv"));d.onkeypress=function(a){B.call(b,
a);C.call(b,a);x.call(b,a)};d.onkeyup=function(a){s.call(b,d.innerText);if(46==a.keyCode||8==a.keyCode)F.call(b),E.call(b),D.call(b),x.call(b,a);if(37==a.keyCode||39==a.keyCode)k.call(b,b._modes.normal),l.call(b,!1);32==a.keyCode&&(k.call(b,b._modes.normal),l.call(b,!1));27==a.keyCode&&(k.call(b,b._modes.normal),l.call(b,!1))}}function h(a){throw Error("otobox - "+a);}var p=function(a){this._options={displayKey:"name",valueKey:"value",namingPrefix:"otobox-"};this._activators=[];this._stackActivator=
this._stack="";this._modes={normal:0,insert:1};this._currentMode=this._modes.normal;var b=this._wrapper=this._currentActivator=null;"object"==typeof a?b=a:"string"==typeof a?(a=document.querySelector(a),null!=a?b=a:h.call(this,"Unable to find the target object with the given CSS selector.")):h.call(this,"Unable to initiate with the given parameter for init.");if(null!=b){this._targetObject=b;var d=b.getBoundingClientRect();a=this._wrapper=document.createElement("div");a.className=this._options.namingPrefix+
"wrapper";b.parentNode.insertBefore(a,b);b.className+=this._options.namingPrefix+"input";a.appendChild(b);var c=document.createElement("div");c.setAttribute("contenteditable",!0);c.setAttribute("data-placeholder",b.placeholder);c.className=this._options.namingPrefix+"editableDiv";c.style.width=d.width+"px";"textarea"==b.nodeName.toLowerCase()&&(c.style.height=d.height+"px");a.appendChild(c);d=document.createElement("ul");d.className=this._options.namingPrefix+"choices";a.appendChild(d);G.call(this,
b)}else h.call(this,"targetObject is empty.")};p.prototype={addActivator:function(a){null!=a?"undefined"!=typeof a.key&&"undefined"!=typeof a.source&&"undefined"!=typeof a.name?(a.allowedChars=a.allowedChars||/.+/,a.key=m.call(this,a),a.customChoice=!!a.customChoice,a.displayKey=a.displayKey||this._options.displayKey,a.valueKey=a.valueKey||this._options.valueKey,a.includeKey="undefined"!=typeof a.includeKey?!!a.includeKey:!0,this._activators.push(a)):h.call(this,"Name, key and source fields are mandatory for activator object."):
h.call(this,"Activator object is empty.");return this},arraySource:function(a,b,d,c){for(var e=[],f=0;f<a.source.length;f++){var g=a.source[f];if(RegExp(b,"gi").test(g)){var h={};h[d.displayKey]=g;h[d.valueKey]=g;e.push(h)}}c.call(this,e)}};return p});
